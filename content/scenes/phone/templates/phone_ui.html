<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CosySim - Phone</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/phone.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/gallery.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/voice_call.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/video_call.css') }}">
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <style>
        /* ---- Input area redesign ---- */
        .message-input-container {
            display: flex;
            flex-direction: column;
            gap: 6px;
            padding: 8px 10px;
            background: #1c1c1e;
            border-top: 1px solid #3a3a3c;
        }
        .input-icons-row {
            display: flex;
            gap: 4px;
            align-items: center;
        }
        .icon-action-btn {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            padding: 4px 6px;
            border-radius: 8px;
            transition: background 0.15s;
            color: #ebebf5cc;
        }
        .icon-action-btn:hover { background: #2c2c2e; }
        .icon-action-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }
        .input-row {
            display: flex;
            align-items: flex-end;
            gap: 8px;
        }
        .message-textarea {
            flex: 1;
            background: #2c2c2e;
            border: 1px solid #3a3a3c;
            border-radius: 18px;
            color: #fff;
            font-size: 15px;
            padding: 10px 14px;
            resize: none;
            outline: none;
            line-height: 1.4;
            max-height: 120px;
            overflow-y: auto;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        }
        .message-textarea::placeholder { color: #8e8e93; }
        .input-send-btn {
            background: #0a84ff;
            border: none;
            border-radius: 50%;
            width: 36px;
            height: 36px;
            font-size: 16px;
            color: #fff;
            cursor: pointer;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.15s;
        }
        .input-send-btn:hover { background: #0070d8; }

        /* Disabled call buttons */
        .call-button-disabled {
            opacity: 0.35;
            cursor: not-allowed !important;
            position: relative;
        }

        /* Conversation list tabs (normal + anon) */
        .conv-tabs {
            display: flex;
            border-bottom: 1px solid #3a3a3c;
            background: #1c1c1e;
        }
        .conv-tab {
            flex: 1;
            padding: 8px;
            text-align: center;
            cursor: pointer;
            color: #8e8e93;
            font-size: 13px;
            transition: background 0.15s, color 0.15s;
        }
        .conv-tab.active { color: #0a84ff; border-bottom: 2px solid #0a84ff; }

        /* Anon chat header glow */
        .anon-header { background: linear-gradient(135deg,#0f0f0f,#1a1a2e); }
        .anon-name { color: #9b59b6; text-shadow: 0 0 8px #9b59b6; }
    </style>
</head>
<body>
    <div class="phone-container">
        <!-- Phone Frame -->
        <div class="phone-frame">
            <!-- Status Bar -->
            <div class="status-bar">
                <div class="status-left">
                    <span class="time" id="statusTime">9:41</span>
                </div>
                <div class="status-right">
                    <span class="signal">üì∂</span>
                    <span class="battery">üîã</span>
                </div>
            </div>

            <!-- Screen Content -->
            <div class="phone-screen" id="phoneScreen">

                <!-- Home Screen -->
                <div class="screen-view" id="homeScreen">
                    <div class="home-wallpaper">
                        <h1 class="home-time" id="homeTime">9:41</h1>
                        <p class="home-date" id="homeDate">Monday, January 1</p>
                    </div>
                    <div class="app-grid">
                        <div class="app-icon" onclick="openApp('messages')">
                            <div class="icon messages-icon">üí¨</div>
                            <span>Messages</span>
                            <span class="badge" id="messageBadge" style="display:none;">0</span>
                        </div>
                        <div class="app-icon" onclick="openGalleryApp()">
                            <div class="icon gallery-icon">üñºÔ∏è</div>
                            <span>Gallery</span>
                        </div>
                        <div class="app-icon" onclick="openApp('camera')">
                            <div class="icon camera-icon">üì∑</div>
                            <span>Camera</span>
                        </div>
                        <div class="app-icon" onclick="window.location.href='http://localhost:5556'">
                            <div class="icon bedroom-icon">üè†</div>
                            <span>Bedroom</span>
                        </div>
                        <div class="app-icon" onclick="window.location.href='http://localhost:8500'">
                            <div class="icon">üåê</div>
                            <span>Hub</span>
                        </div>
                        <div class="app-icon" onclick="openApp('settings')">
                            <div class="icon settings-icon">‚öôÔ∏è</div>
                            <span>Settings</span>
                        </div>
                    </div>
                    <div class="dock">
                        <div class="dock-icon" onclick="openApp('messages')">üí¨</div>
                        <div class="dock-icon" onclick="openApp('phone')">üìû</div>
                        <div class="dock-icon" onclick="openApp('camera')">üì∑</div>
                    </div>
                </div>

                <!-- Messages App -->
                <div class="screen-view" id="messagesScreen" style="display:none;">
                    <!-- Conversation tabs: Normal / Anonymous -->
                    <div class="conv-tabs">
                        <div class="conv-tab active" id="tabNormal" onclick="switchConvTab('normal')">üí¨ Chat</div>
                        <div class="conv-tab" id="tabAnon" onclick="switchConvTab('anon')">‚ùì Unknown</div>
                    </div>

                    <!-- Normal chat header -->
                    <div class="app-header" id="normalChatHeader">
                        <button class="back-button" onclick="goHome()">‚Üê</button>
                        <div class="header-content">
                            <h2 id="contactName">Loading...</h2>
                            <p class="header-subtitle" id="contactStatus">Active</p>
                        </div>
                        <button class="settings-icon-btn" onclick="openAutonomousSettings()" title="Autonomous Settings">‚öôÔ∏è</button>
                        <button class="gallery-icon-btn" onclick="openGalleryView()" title="Gallery">üñºÔ∏è</button>
                        <!-- Calls disabled - not implemented yet -->
                        <button class="call-button call-button-disabled" title="Video Call (coming soon)" disabled>üìπ</button>
                        <button class="call-button call-button-disabled" title="Voice Call (coming soon)" disabled>üìû</button>
                    </div>

                    <!-- Anon chat header -->
                    <div class="app-header anon-header" id="anonChatHeader" style="display:none;">
                        <button class="back-button" onclick="goHome()">‚Üê</button>
                        <div class="header-content">
                            <h2 class="anon-name" id="anonDisplayName">‚ùì Unknown</h2>
                            <p class="header-subtitle" id="anonStatus">...</p>
                        </div>
                    </div>

                    <!-- Messages area (shared, swapped per tab) -->
                    <div class="messages-container" id="messagesContainer">
                        <!-- Messages appended here -->
                    </div>

                    <div class="typing-indicator" id="typingIndicator" style="display:none;">
                        <div class="typing-dots"><span></span><span></span><span></span></div>
                    </div>

                    <!-- Input area: icons row + textarea row -->
                    <div class="message-input-container">
                        <div class="input-icons-row">
                            <button class="icon-action-btn" onclick="openPhotoUpload()" title="Send photo">üì∑</button>
                            <button class="icon-action-btn" onclick="requestPhoto()" title="Request selfie">üñºÔ∏è</button>
                            <button class="icon-action-btn" id="btnVoiceMsg" onclick="sendVoiceMessage()" title="Voice message">üé§</button>
                            <button class="icon-action-btn" id="btnVideoMsg" onclick="sendVideoMessage()" title="Video message">üé•</button>
                            <button class="icon-action-btn call-button-disabled" title="Voice call (coming soon)" disabled>üìû</button>
                            <button class="icon-action-btn call-button-disabled" title="Video call (coming soon)" disabled>üìπ</button>
                        </div>
                        <div class="input-row">
                            <textarea id="messageInput"
                                      class="message-textarea"
                                      rows="3"
                                      placeholder="Message..."
                                      onkeydown="handleMessageKeyDown(event)"></textarea>
                            <button class="input-send-btn" onclick="sendMessage()">‚û§</button>
                        </div>
                    </div>
                </div>

                <!-- Photo Upload Dialog -->
                <div class="photo-upload-dialog" id="photoUploadDialog" style="display:none;">
                    <div class="dialog-content">
                        <h3>Send Photo</h3>
                        <div class="upload-options">
                            <button class="upload-btn" onclick="triggerFileUpload()">üìÅ Choose from device</button>
                            <button class="upload-btn generate-btn" onclick="generateSelfie()">‚ú® Generate selfie</button>
                        </div>
                        <div class="photo-preview" id="photoPreview" style="display:none;">
                            <img id="previewImage" src="" alt="Preview">
                            <div class="preview-actions">
                                <button class="btn-send" onclick="uploadPhoto()">Send</button>
                                <button class="btn-cancel" onclick="cancelPhotoUpload()">Cancel</button>
                            </div>
                        </div>
                        <input type="file" id="photoFileInput" accept="image/*" style="display:none;" onchange="handleFileSelect(event)">
                        <button class="close-dialog" onclick="closePhotoUpload()">‚úï</button>
                    </div>
                </div>

                <!-- Gallery View Overlay -->
                <div class="gallery-view-overlay" id="galleryViewOverlay" style="display:none;">
                    <div class="gallery-view-container">
                        <div class="gallery-view-header">
                            <h3>Gallery</h3>
                            <button class="close-gallery-btn" onclick="closeGalleryView()">‚úï</button>
                        </div>
                        <div class="gallery-view-grid" id="galleryViewGrid">
                            <p style="text-align:center;color:#666;margin-top:50px;">Loading...</p>
                        </div>
                    </div>
                </div>

                <!-- Autonomous Settings Modal -->
                <div class="autonomous-settings-overlay" id="autonomousSettingsOverlay" style="display:none;">
                    <div class="autonomous-settings-modal">
                        <div class="modal-header">
                            <h3>Autonomous Messaging</h3>
                            <button class="close-modal-btn" onclick="closeAutonomousSettings()">‚úï</button>
                        </div>
                        <div class="modal-body">
                            <div class="setting-item">
                                <label class="toggle-label">
                                    <span>Enable Autonomous Messages</span>
                                    <input type="checkbox" id="autonomousToggle" onchange="toggleAutonomous()">
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                            <div class="setting-item">
                                <label>Message Frequency</label>
                                <select id="frequencySelect" onchange="updateAutonomousSettings()">
                                    <option value="low">Low (1-2 hours)</option>
                                    <option value="moderate" selected>Moderate (30min-1hr)</option>
                                    <option value="high">High (10-30 minutes)</option>
                                </select>
                            </div>
                            <div class="setting-item">
                                <label>Active Hours</label>
                                <div class="time-range-slider">
                                    <input type="range" id="startHourSlider" min="0" max="23" value="8" oninput="updateTimeRange()">
                                    <input type="range" id="endHourSlider" min="0" max="23" value="23" oninput="updateTimeRange()">
                                </div>
                                <div class="time-range-display">
                                    <span id="timeRangeDisplay">8:00 AM - 11:00 PM</span>
                                </div>
                            </div>
                            <div class="setting-item">
                                <label class="checkbox-label">
                                    <input type="checkbox" id="enablePhotosCheck" checked onchange="updateAutonomousSettings()">
                                    <span>Enable Autonomous Photos</span>
                                </label>
                            </div>
                            <div class="modal-actions">
                                <button class="btn-save" onclick="saveAutonomousSettings()">Save Settings</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Gallery App (full screen) -->
                <div class="screen-view" id="galleryScreen" style="display:none;">
                    <div class="app-header">
                        <button class="back-button" onclick="goHome()">‚Üê</button>
                        <h2>Gallery</h2>
                        <button class="refresh-btn" onclick="loadGallery()">üîÑ</button>
                    </div>
                    <div class="gallery-grid" id="galleryGrid">
                        <p style="text-align:center;color:#666;margin-top:50px;">Loading gallery...</p>
                    </div>
                </div>

                <!-- Full Screen Photo Viewer -->
                <div class="photo-viewer" id="photoViewer" style="display:none;">
                    <button class="close-viewer" onclick="closePhotoViewer()">‚úï</button>
                    <img id="viewerImage" src="" alt="Photo">
                    <div class="viewer-controls">
                        <button onclick="downloadPhoto()">‚¨áÔ∏è Download</button>
                    </div>
                </div>

            </div><!-- /phone-screen -->

            <!-- Navigation Bar -->
            <div class="nav-bar">
                <div class="nav-button" onclick="goHome()">‚óÄ</div>
                <div class="nav-button" onclick="goHome()">‚ö´</div>
                <div class="nav-button">‚ñ£</div>
            </div>
        </div><!-- /phone-frame -->

        <!-- Control Panel -->
        <div class="control-panel">
            <h3>CosySim Control</h3>
            <div class="control-section">
                <label>Active Character:</label>
                <select id="characterSelect" onchange="selectCharacter()">
                    <option value="">Loading...</option>
                </select>
            </div>
            <div class="control-section">
                <label>Scene Management:</label>
                <div style="display:flex;gap:5px;flex-wrap:wrap;">
                    <button onclick="saveScene()" title="Save current scene">üíæ Save</button>
                    <button onclick="loadScene()" title="Load saved scene">üìÇ Load</button>
                    <select id="sceneSelect" style="flex:1;min-width:120px;">
                        <option value="">Select Scene...</option>
                    </select>
                </div>
            </div>
            <div class="control-section">
                <label>Connection:</label>
                <span id="connectionStatus" class="status-indicator">Disconnected</span>
            </div>
            <div class="control-section">
                <button onclick="simulateIncomingMessage()">Simulate Message</button>
                <button onclick="simulateIncomingCall()">Simulate Call</button>
            </div>
        </div>
    </div><!-- /phone-container -->

    <script src="{{ url_for('static', filename='js/video.js') }}"></script>
    <script src="{{ url_for('static', filename='js/voice.js') }}"></script>
    <script src="{{ url_for('static', filename='js/phone.js') }}"></script>
    <script>
    // ================================================================
    //  Phone UI Extensions
    //  - Auto-scroll
    //  - Textarea enter-to-send (shift+enter = newline)
    //  - Conversation tab switching (normal / anon)
    //  - Voice & video message triggers
    // ================================================================

    // Override key handler for textarea
    function handleMessageKeyDown(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
        }
    }

    // Keep the old onkeypress based handler as alias (phone.js uses it)
    function handleMessageKeyPress(e) { /* no-op, replaced by handleMessageKeyDown */ }

    // Auto-scroll helper ‚Äì called after every new message bubble is added
    function scrollToBottom() {
        const c = document.getElementById('messagesContainer');
        if (c) { c.scrollTop = c.scrollHeight; }
    }

    // Patch addMessage so it always scrolls after inserting
    const _origAddMessage = typeof addMessage === 'function' ? addMessage : null;
    function patchAddMessage() {
        if (typeof addMessage === 'function' && !addMessage._patched) {
            const original = addMessage;
            window.addMessage = function() {
                original.apply(this, arguments);
                scrollToBottom();
            };
            window.addMessage._patched = true;
        }
    }
    document.addEventListener('DOMContentLoaded', function() {
        setTimeout(patchAddMessage, 500);
    });

    // ---- Conversation Tab Switching ----
    let activeConvTab = 'normal';          // 'normal' or 'anon'
    let normalMessages = [];               // cached messages for normal chat
    let anonMessages = [];                 // cached messages for anon chat
    let anonInfo = null;

    function switchConvTab(tab) {
        activeConvTab = tab;
        document.getElementById('tabNormal').classList.toggle('active', tab === 'normal');
        document.getElementById('tabAnon').classList.toggle('active', tab === 'anon');
        document.getElementById('normalChatHeader').style.display = tab === 'normal' ? '' : 'none';
        document.getElementById('anonChatHeader').style.display  = tab === 'anon'   ? '' : 'none';

        const container = document.getElementById('messagesContainer');
        container.innerHTML = '';

        if (tab === 'normal') {
            normalMessages.forEach(m => _renderMessage(m, container));
        } else {
            loadAnonChat();
        }
        scrollToBottom();
    }

    function _renderMessage(msg, container) {
        const div = document.createElement('div');
        div.className = 'message ' + (msg.role === 'user' ? 'sent' : 'received');
        div.innerHTML = '<span class="message-text">' + escapeHtml(msg.content || msg.text || '') + '</span>'
                      + '<span class="message-time">' + (msg.time || '') + '</span>';
        container.appendChild(div);
    }

    function escapeHtml(s) {
        return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
    }

    // Load anon chat from backend
    function loadAnonChat() {
        fetch('/api/anon/info')
            .then(r => r.json())
            .then(info => {
                anonInfo = info;
                document.getElementById('anonDisplayName').textContent = info.display_name || '‚ùì Unknown';
                document.getElementById('anonStatus').textContent = info.status || '...';
            }).catch(() => {});

        fetch('/api/anon/history')
            .then(r => r.json())
            .then(data => {
                const container = document.getElementById('messagesContainer');
                container.innerHTML = '';
                (data.history || []).forEach(m => _renderMessage(m, container));
                scrollToBottom();
            }).catch(() => {});
    }

    // Override sendMessage to route to correct backend
    const _origSendMessage = typeof sendMessage === 'function' ? sendMessage : null;
    function patchSendMessage() {
        if (typeof sendMessage === 'function' && !sendMessage._tabPatched) {
            const origFn = sendMessage;
            window.sendMessage = function() {
                if (activeConvTab === 'anon') {
                    const input = document.getElementById('messageInput');
                    const msg = input.value.trim();
                    if (!msg) return;
                    input.value = '';
                    // Append user bubble immediately
                    const container = document.getElementById('messagesContainer');
                    _renderMessage({role:'user', content: msg, time: new Date().toLocaleTimeString()}, container);
                    scrollToBottom();
                    // POST to anon endpoint
                    fetch('/api/anon/message', {
                        method: 'POST',
                        headers: {'Content-Type':'application/json'},
                        body: JSON.stringify({message: msg})
                    }).then(r => r.json()).then(data => {
                        if (data.reply) {
                            _renderMessage({role:'assistant', content: data.reply, time: new Date().toLocaleTimeString()}, container);
                            scrollToBottom();
                        }
                    }).catch(() => {});
                } else {
                    origFn.apply(this, arguments);
                }
            };
            window.sendMessage._tabPatched = true;
        }
    }
    document.addEventListener('DOMContentLoaded', function() {
        setTimeout(patchSendMessage, 600);
    });

    // ---- Voice & Video Message Triggers ----
    function sendVoiceMessage() {
        if (!window.socket) return;
        const input = document.getElementById('messageInput');
        const text = input.value.trim() || null;
        window.socket.emit('send_voice_message', { text: text, mood: 'happy' });
    }

    function sendVideoMessage() {
        if (!window.socket) return;
        const input = document.getElementById('messageInput');
        const text = input.value.trim() || null;
        window.socket.emit('send_video_message', { text: text, mood: 'happy' });
    }

    function openGalleryApp() {
        document.querySelectorAll('.screen-view').forEach(el => el.style.display = 'none');
        document.getElementById('galleryScreen').style.display = '';
        if (typeof loadGallery === 'function') loadGallery();
    }

    // Clock update
    function updateClock() {
        const now = new Date();
        const t = now.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
        const el = document.getElementById('statusTime');
        const hel = document.getElementById('homeTime');
        if (el) el.textContent = t;
        if (hel) hel.textContent = t;
        // Date
        const del = document.getElementById('homeDate');
        if (del) del.textContent = now.toLocaleDateString([], {weekday:'long', month:'long', day:'numeric'});
    }
    setInterval(updateClock, 1000);
    updateClock();
    </script>
</body>
</html>
